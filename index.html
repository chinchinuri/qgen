<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Генератор QR-кодів</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">Генератор QR-кодів</h1>
        <div class="row">
            <div class="col-md-6">
                <form id="qr-form">
                    <div class="mb-3">
                        <label for="qr-text" class="form-label">Текст для QR-коду:</label>
                        <input type="text" class="form-control" id="qr-text" required>
                    </div>
                    <div class="mb-3">
                        <label for="qr-size" class="form-label">Розмір (пікселі):</label>
                        <input type="number" class="form-control" id="qr-size" value="512" min="128" max="1024">
                    </div>
                    <div class="mb-3">
                        <label for="qr-background" class="form-label">Колір фону:</label>
                        <input type="color" class="form-control" id="qr-background" value="#ffffff">
                    </div>
                    <div class="mb-3">
                        <label for="qr-foreground" class="form-label">Колір елементів:</label>
                        <input type="color" class="form-control" id="qr-foreground" value="#000000">
                    </div>
                    <div class="mb-3">
                        <label for="qr-background-radius" class="form-label">Округлість кутів фону:</label>
                        <input type="range" class="form-range" id="qr-background-radius" min="0" max="50" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="qr-dot-radius" class="form-label">Округлість кутів крапок:</label>
                        <input type="range" class="form-range" id="qr-dot-radius" min="0" max="50" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="qr-corner-radius" class="form-label">Округлість кутів елементів позиціонування:</label>
                        <input type="range" class="form-range" id="qr-corner-radius" min="0" max="50" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="qr-margin" class="form-label">Поля (модулі):</label>
                        <input type="number" class="form-control" id="qr-margin" value="4" min="0" max="10">
                    </div>
                    <button type="submit" class="btn btn-primary">Згенерувати QR-код</button>
                </form>
            </div>
            <div class="col-md-6">
                <canvas id="qr-canvas"></canvas>
                <div class="mt-3">
                    <button id="save-svg" class="btn btn-success">Зберегти як SVG</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const qrCanvas = document.getElementById('qr-canvas');
    const qrForm = document.getElementById('qr-form');
    const saveSvgBtn = document.getElementById('save-svg');

    let qr;

    qrForm.addEventListener('submit', function(e) {
        e.preventDefault();
        generateQR();
    });

    saveSvgBtn.addEventListener('click', saveSVG);

    function generateQR() {
        const text = document.getElementById('qr-text').value;
        const size = parseInt(document.getElementById('qr-size').value);
        const background = document.getElementById('qr-background').value;
        const foreground = document.getElementById('qr-foreground').value;
        const backgroundRadius = parseInt(document.getElementById('qr-background-radius').value);
        const dotRadius = parseInt(document.getElementById('qr-dot-radius').value);
        const cornerRadius = parseInt(document.getElementById('qr-corner-radius').value);
        const margin = parseInt(document.getElementById('qr-margin').value);

        // Створюємо тимчасовий canvas для генерації QR-коду
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = size;
        tempCanvas.height = size;

        qr = new QRious({
            element: tempCanvas,
            value: text,
            size: size,
            background: 'rgba(0,0,0,0)', // Прозорий фон
            foreground: foreground,
            level: 'H',
            padding: margin
        });

        // Застосовуємо округлість кутів та фон
        applyCornerRadius(tempCanvas, backgroundRadius, dotRadius, cornerRadius, background);
    }

    function applyCornerRadius(tempCanvas, backgroundRadius, dotRadius, cornerRadius, backgroundColor) {
        const ctx = qrCanvas.getContext('2d');
        const size = tempCanvas.width;

        // Очищаємо основний canvas
        ctx.clearRect(0, 0, size, size);

        // Малюємо округлений фон
        ctx.fillStyle = backgroundColor;
        ctx.beginPath();
        ctx.roundRect(0, 0, size, size, backgroundRadius);
        ctx.fill();

        // Отримуємо дані QR-коду
        const tempCtx = tempCanvas.getContext('2d');
        const imageData = tempCtx.getImageData(0, 0, size, size);
        const data = imageData.data;

        // Створюємо новий ImageData для обробленого QR-коду
        const processedImageData = ctx.createImageData(size, size);
        const processedData = processedImageData.data;

        const moduleSize = size / qr.modules;

        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const i = (y * size + x) * 4;
                const moduleX = Math.floor(x / moduleSize);
                const moduleY = Math.floor(y / moduleSize);

                if (data[i + 3] > 0) { // Якщо піксель не прозорий
                    if (isPositioningSquare(moduleX, moduleY, qr.modules)) {
                        applyRadiusToModule(processedData, x, y, size, cornerRadius);
                    } else {
                        applyRadiusToModule(processedData, x, y, size, dotRadius);
                    }
                }
            }
        }

        // Накладаємо оброблений QR-код на фон
        ctx.putImageData(processedImageData, 0, 0);
    }

    function isPositioningSquare(x, y, modules) {
        const size = modules.length;
        return (x < 7 && y < 7) || (x > size - 8 && y < 7) || (x < 7 && y > size - 8);
    }

    function applyRadiusToModule(data, x, y, size, radius) {
        const i = (y * size + x) * 4;
        const corners = [
            [x - 0.5, y - 0.5],
            [x + 0.5, y - 0.5],
            [x - 0.5, y + 0.5],
            [x + 0.5, y + 0.5]
        ];

        let inside = false;
        for (const [cx, cy] of corners) {
            if (Math.sqrt((x - cx) ** 2 + (y - cy) ** 2) <= radius) {
                inside = true;
                break;
            }
        }

        if (inside) {
            data[i] = 0;
            data[i + 1] = 0;
            data[i + 2] = 0;
            data[i + 3] = 255;
        }
    }

    function saveSVG() {
        const svg = generateSVG();
        const blob = new Blob([svg], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = getFileName();
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function generateSVG() {
        const size = parseInt(document.getElementById('qr-size').value);
        const background = document.getElementById('qr-background').value;
        const foreground = document.getElementById('qr-foreground').value;
        const backgroundRadius = parseInt(document.getElementById('qr-background-radius').value);
        
        const svgNS = "http://www.w3.org/2000/svg";
        const svg = document.createElementNS(svgNS, "svg");
        svg.setAttribute("width", size);
        svg.setAttribute("height", size);
        svg.setAttribute("viewBox", `0 0 ${size} ${size}`);

        // Додаємо фон з округленими кутами
        const background_rect = document.createElementNS(svgNS, "rect");
        background_rect.setAttribute("width", size);
        background_rect.setAttribute("height", size);
        background_rect.setAttribute("fill", background);
        background_rect.setAttribute("rx", backgroundRadius);
        background_rect.setAttribute("ry", backgroundRadius);
        svg.appendChild(background_rect);

        // Додаємо QR-код
        const qr_image = document.createElementNS(svgNS, "image");
        qr_image.setAttribute("width", size);
        qr_image.setAttribute("height", size);
        qr_image.setAttribute("href", qrCanvas.toDataURL());
        svg.appendChild(qr_image);

        return new XMLSerializer().serializeToString(svg);
    }

    function getFileName() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day}-${hours}-${minutes}-${seconds}.svg`;
    }
</script>
</body>
</html>
